var MTProto=function(e){"use strict";var r,t,n,s,a=[],o=function(){a.forEach((function(e){e()}))};t=window,n="resize",s=function(){r&&clearTimeout(r),r=setTimeout(o,100)},t.addEventListener(n,s);var i=function(){var e={};return e.promise=new Promise((function(r,t){e.resolve=r,e.reject=t})),e},c=function(e){e.constructor!=Uint8Array&&(e=Uint8Array.from(e));for(var r=[],t=0,n=e.length;t<n;t+=32768)r.push(String.fromCharCode.apply(null,e.subarray(t,t+32768)));return r.join("")};function f(e){return(f="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function u(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var h=function(e){return Math.floor(Math.random()*e)},l=function(e){for(var r=[],t=0;t<e;t++)r.push(h(255));return r};function d(e){var r,t=e.length,n=0,s=[];for(e.length%2&&(s.push(parseInt(e.charAt(0),16)),n++),r=n;r<t;r+=2)s.push(parseInt(e.substr(r,2),16));return s}var y=function(e){for(var r=new ArrayBuffer(e.length),t=new Uint8Array(r),n=0,s=e.length;n<s;n++)t[n]=e.charCodeAt(n);return Array.from(t)},v=function(e){return Array.from(e,(function(e){return("0"+(255&e).toString(16)).slice(-2)})).join("")},g=function(e){return v(y(e))},p=function(e,r){return e.toString()==r.toString()},b=function(e,r){var t=e.byteLength||e.length,n=r.byteLength||r.length,s=new Uint8Array(t+n);return s.set(e instanceof ArrayBuffer?new Uint8Array(e):e,0),s.set(r instanceof ArrayBuffer?new Uint8Array(r):r,t),s.buffer};function m(e,r,t){var n=(r=r||16)-(e.byteLength||e.length)%r;if(n>0&&n<r){var s=new Array(n);if(t)for(var a=0;a<n;a++)s[a]=0;else s=l(n);e=e instanceof ArrayBuffer?b(e,s):e.concat(s)}return e}var _=function(e,r,t,n){for(var s=0;s<n;s++)e[t+s]^=r[s]};function w(e,r){for(var t=e.length,n=[],s=0;s<t;++s)n[s]=e[s]^r[s];return n}var A,I=function(e,r,t){for(var n=new aesjs.AES(e),s=r.slice(0,16),a=r.slice(16,32),o=Uint8Array.from(y(t)),i=0,c=o.length;i<c;i+=16){var f=o.slice(i,i+16);_(o,a,i,16),o.set(n.decrypt(o.slice(i,i+16)),i),_(o,s,i,16),s=f,a=o.slice(i,i+16)}return o},S=function(e,r,t){t=m(t);for(var n=new aesjs.AES(e),s=r.slice(0,16),a=r.slice(16,32),o=Uint8Array.from(t),i=0,c=o.length;i<c;i+=16){var f=o.slice(i,i+16);_(o,s,i,16),o.set(n.encrypt(o.slice(i,i+16)),i),_(o,a,i,16),s=o.slice(i,i+16),a=f}return o},U=function(e){return(e=parseInt(e))<0&&(e+=4294967296),e},k=function(e){return e>2147483647&&(e-=4294967296),e},N=function(e,r){return bigInt(e).shiftLeft(32).xor(bigInt(r)).toString(10)},V=function(e,r,t){return bigInt.fromArray(e,256).modPow(bigInt.fromArray(r,256),bigInt.fromArray(t,256)).toArray(256).value},T=function(e,r,t){var n=t?8:0,s=new Uint8Array(52),a=new Uint8Array(52);s.set(r,0),s.set(e.subarray(n,n+36),16);var o=new Uint8Array(d(sha256(c(s))));a.set(e.subarray(40+n,40+n+36),0),a.set(r,36);var i=new Uint8Array(d(sha256(c(a)))),f=new Uint8Array(32),u=new Uint8Array(32);return f.set(o.subarray(0,8)),f.set(i.subarray(8,24),8),f.set(o.subarray(24,32),24),u.set(i.subarray(0,8)),u.set(o.subarray(8,24),8),u.set(i.subarray(24,32),24),[f,u]},D=function(e,r){var t=e&&void 0!==e.byteLength;t||(r=e),r=r||{},length=t?e.byteLength:r.length||2048;var n,s=r.schema||"api";return{buffer:n=t?e:new ArrayBuffer(length),intView:new Int32Array(n),byteView:new Uint8Array(n),length:length,schema:s,offset:0}},q=function(e,r){if(!(e.offset+r<e.length)){var t=4*Math.ceil(Math.max(2*e.length,e.offset+r+16)/4),n=e.intView;e.length=t,e.buffer=new ArrayBuffer(t),e.intView=new Int32Array(e.buffer),e.byteView=new Uint8Array(e.buffer),e.intView.set(n)}},M=function(e){var r=U(P(e));return 2574415285==r||3162085175!=r&&(e.offset-=4,R(e,"Object"))},C=function(e,r){q(e,4),e.intView[e.offset/4]=r,e.offset+=4},P=function(e){var r=e.intView[e.offset/4];return e.offset+=4,r},B=function(e,r){if(r._bytes)x(e,r._bytes,!0);else if(Array.isArray(r))2==r.length?(C(e,r[1]),C(e,r[0])):K(e,r,64);else{"string"!=typeof r&&(r=r?r.toString():"0");var t=bigInt(r).divmod(bigInt("100000000",16)),n=t.quotient.valueOf();C(e,U(t.remainder.valueOf())),C(e,n<0?n-1:n)}},G=function(e){var r=P(e),t=P(e),n=new String(N(t,r));return n._bytes=e.byteView.slice(e.offset-8,e.offset),n},K=function(e,r,t){r instanceof ArrayBuffer&&(r=new Uint8Array(r));var n=r.length;t%32||8*n!=t||(q(e,n),e.byteView.set(r,e.offset),e.offset+=n)},L=function(e,r,t){var n=r/8;if(t){var s=e.byteView.subarray(e.offset,e.offset+n);return e.offset+=n,s}for(var a=[],o=0;o<n;o++)a.push(e.byteView[e.offset++]);return a},x=function(e,r,t){r instanceof ArrayBuffer?r=new Uint8Array(r):r||(r=[]);var n=r.byteLength||r.length;for(q(e,n+8),t||(n<253?e.byteView[e.offset++]=n:(e.byteView[e.offset++]=254,e.byteView[e.offset++]=255&n,e.byteView[e.offset++]=(65280&n)>>8,e.byteView[e.offset++]=(16711680&n)>>16)),e.byteView.set(r,e.offset),e.offset+=n;e.offset%4;)e.byteView[e.offset++]=0},E=function(e,r,t){r?t=t||e.byteView.byteLength-e.offset:254==(t=e.byteView[e.offset++])&&(t=e.byteView[e.offset++]|e.byteView[e.offset++]<<8|e.byteView[e.offset++]<<16);var n=e.byteView.subarray(e.offset,e.offset+t);if(r)e.offset+=t;else for(;e.offset%4;)e.offset++;return n},H=function e(r,t,n){switch(t){case"#":case"int":return C(r,n);case"long":return B(r,n);case"int128":return K(r,n,128);case"int256":return K(r,n,256);case"int512":return K(r,n,512);case"string":return function(e,r){var t=(r=r||"").length;q(e,t+8),t<253?e.byteView[e.offset++]=t:(e.byteView[e.offset++]=254,e.byteView[e.offset++]=255&t,e.byteView[e.offset++]=(65280&t)>>8,e.byteView[e.offset++]=(16711680&t)>>16);for(var n=0;n<t;n++)e.byteView[e.offset++]=r.charCodeAt(n);for(;e.offset%4;)e.byteView[e.offset++]=0}(r,n);case"bytes":return x(r,n);case"double":return function(e,r){var t=new ArrayBuffer(8),n=new Int32Array(t);new Float64Array(t)[0]=r,C(e,n[0]),C(e,n[1])}(r,n);case"Bool":return function(e,r){C(e,r?2574415285:3162085175)}(r,n);case"!X":return x(r,new Uint8Array(n),!0);case"true":return}if(Array.isArray(n)){"Vector"==t.substr(0,6)&&C(r,481674261);var s=t.substr(7,t.length-8);return C(r,n.length),void n.forEach((function(t){e(r,s,t)}))}if("object"==f(n)){var a="%"==t.charAt(0);a&&(t=t.substr(1));for(var o,i=TGInit.resources["schema-"+r.schema],c=n._,u=0,h=i.constructors.length;u<h;u++)if(i.constructors[u].predicate==c){o=i.constructors[u];break}if(!o)for(var l=0,d=i.constructors.length;l<d;l++)if(i.constructors[l].type==t){o=i.constructors[l];break}if(!o)return;c==t&&(function(e){throw new Error('"'+e+'" is read-only')}("isBare"),a=!0),a||C(r,U(o.id));for(var y=0,v=o.params.length;y<v;y++){var g=o.params[y],p=g.type;if(p.includes("?")){var b=p.split("?"),m=b[0].split(".");if(!(n[m[0]]&1<<m[1]))continue;p=b[1]}e(r,p,n[g.name])}}},R=function e(r,t,n){switch(t=t||""){case"#":case"int":return P(r);case"long":return G(r);case"int128":return L(r,128,!1);case"int256":return L(r,256,!1);case"int512":return L(r,512,!1);case"string":return function(e){var r=e.byteView[e.offset++];254==r&&(r=e.byteView[e.offset++]|e.byteView[e.offset++]<<8|e.byteView[e.offset++]<<16);for(var t,n="",s=0;s<r;s++)n+=String.fromCharCode(e.byteView[e.offset++]);for(;e.offset%4;)e.offset++;try{t=decodeURIComponent(escape(n))}catch(e){t=n}return t}(r);case"bytes":return E(r);case"double":return function(e){var r=new ArrayBuffer(8),t=new Int32Array(r),n=new Float64Array(r);return t[0]=P(e),t[1]=P(e),n[0]}(r);case"Bool":return M(r);case"true":return!0}if("vector"==t.substr(0,6).toLowerCase()){if("V"==t.charAt(0)){var s=P(r),a=k(s);if(812830625==a){var o=E(r),i=new Zlib.Gunzip(o).decompress(),c=new Uint8Array(i).buffer;return e(D(c),t)}if(481674261!=a)return}var f=P(r),u=[];if(f>0)for(var h=t.substr(7,t.length-8),l=0;l<f;l++)u.push(e(r,h));return u}var d,y=TGInit.resources["schema-"+r.schema];if("%"==t.charAt(0)){for(var v=t.substr(1),g=0,p=y.constructors.length;g<p;g++)if(y.constructors[g].type==v){d=y.constructors[g];break}if(!d)return r.schemaChanged?void 0:(r.schema="mtproto"==r.schema?"api":"mtproto",r.schemaChanged=!0,e(r,t))}else if(t.charAt(0)>=97&&t.charAt(0)<=122){for(var b=0,m=y.constructors.length;b<m;b++)if(y.constructors[b].predicate==t){d=y.constructors[b];break}if(!d)return r.schemaChanged?void 0:(r.schema="mtproto"==r.schema?"api":"mtproto",r.schemaChanged=!0,e(r,t))}else{var _=P(r),w=k(_);if(812830625==w){var A=E(r),I=new Zlib.Gunzip(A).decompress(),S=new Uint8Array(I).buffer;return e(D(S),t)}var U=y.indexes;if(!U){y.indexes=U={};for(var N=0,V=y.constructors.length;N<V;N++)U[y.constructors[N].id]=N}var T=U[w];if(null!=T&&(d=y.constructors[T]),!d)return r.schemaChanged?void 0:(r.offset-=4,r.schema="mtproto"==r.schema?"api":"mtproto",r.schemaChanged=!0,e(r,t))}for(var q=d.predicate,C={_:q},B=0,K=d.params.length;B<K;B++){var x=d.params[B],H=x.type;"#"!=H||C.pFlags||(C.pFlags={});var R=H.includes("?");if(R){var j=H.split("?"),z=j[0].split(".");if(!(C[z[0]]&1<<z[1]))continue;H=j[1]}"rpc_result"==q&&"result"==x.name&&n[C.req_msg_id]&&(H=n[C.req_msg_id].resType);var F=e(r,H);R&&"true"==H?C.pFlags[x.name]=F:C[x.name]=F}return C},j=function(e){var r=new ArrayBuffer(e.offset),t=new Int32Array(r);return t.set(e.intView.subarray(0,e.offset/4)),t.buffer},z=function(e,r,t){var n=D({schema:t=t||"api"}),s=function(e,r,t){for(var n,s=TGInit.resources["schema-"+e.schema],a=0,o=s.methods.length;a<o;a++)if(s.methods[a].method==r){n=s.methods[a];break}C(e,U(n.id));for(var i=0,c=n.params.length;i<c;i++){var f=n.params[i],u=f.type;if(u.includes("?")){var h=u.split("?"),l=h[0].split(".");if(!(t[l[0]]&1<<l[1]))continue;u=h[1]}H(e,u,t[f.name])}return n.type}(n,e,r),a=j(n);return a._resType=s,a},F=function(e,r,t){var n=D({schema:t=t||"api"});return H(n,e,r),j(n)},O=[0,0],W=parseInt(TGInit.getStorage("server_time_offset"))||0,Q=function(e){var r=i(),t={};return Promise.resolve().then((function(){t.initNonce=l(16);var r=z("req_pq_multi",{nonce:t.initNonce},"mtproto");return e.send(r)})).then((function(r){var n=R(r.tl,"ResPQ");if(t.pq=n.pq,t.serverNonce=n.server_nonce,t.publicKey=function(e){for(var r=TGInit.resources["public-keys"],t=0,n=e.length;t<n;t++)if(r[e[t]]){var s=r[e[t]];return s.fp=e[t],s}}(n.server_public_key_fingerprints),!p(t.initNonce,n.nonce))throw"Nonce not compare";var s=function(e){for(var r=bigInt.fromArray(y(e),256),t=bigInt.randBetween(bigInt.one,r.prev()),n=bigInt.randBetween(bigInt.one,r.prev()),s=bigInt.randBetween(bigInt.one,r.prev()),a=bigInt("1"),o=bigInt("1"),i=bigInt("1"),f=bigInt("0"),u=bigInt("0");a.equals(bigInt.one);){f=bigInt(t);for(var h=bigInt(bigInt.zero);h.lesser(o);h=h.next())t=t.modPow(2,r).add(n).remainder(r);for(var l=bigInt("0");l.lesser(o)&&a.equals(bigInt.one);){u=bigInt(t);for(var v=bigInt.min(s,o.subtract(l)),g=bigInt(bigInt.zero);g.lesser(v);g=g.next())t=t.modPow(2,r).add(n).remainder(r),i=i.multiply(f.subtract(t).abs()).remainder(r);a=bigInt.gcd(i,r),l=l.add(s)}o=o.multiply(2)}if(a.equals(r))for(;u=u.modPow(2,r).add(n).remainder(r),!((a=bigInt.gcd(f.subtract(u).abs(),r))>1););var p=a,b=r.divide(p);if(p.greater(b)){var m=p;p=b,b=m}return{p:c(d(p.toString(16))),q:c(d(b.toString(16)))}}(n.pq);t.p=s.p,t.q=s.q,t.newNonce=l(32);var a,o,i,f,u,h=F("P_Q_inner_data",{_:"p_q_inner_data",pq:t.pq,p:t.p,q:t.q,nonce:t.initNonce,server_nonce:t.serverNonce,new_nonce:t.newNonce},"mtproto"),v=z("req_DH_params",{nonce:t.initNonce,server_nonce:t.serverNonce,p:t.p,q:t.q,public_key_fingerprint:t.publicKey.fp,encrypted_data:c((a=t.publicKey,o=h,i=m(sha1.array(o).concat(Array.from(new Uint8Array(o))),255),f=bigInt(a.m,16),u=bigInt(a.e,16),d(bigInt.fromArray(i,256).modPow(u,f).toString(16))))},"mtproto");return e.send(v)})).then((function(r){var n=R(r.tl,"Server_DH_Params");if(!n)throw"Server DH params error";if(!p(t.initNonce,n.nonce))throw"Nonce not compare";if(!p(t.serverNonce,n.server_nonce))throw"Server nonce not compare";var s=t.serverNonce.concat(t.newNonce);t.tempAesKey=sha1.array(t.newNonce.concat(t.serverNonce)).concat(sha1.array(s).slice(0,12)),t.tempAesIv=sha1.array(s).slice(12).concat(sha1.array(t.newNonce.concat(t.newNonce)),t.newNonce.slice(0,4));var a,o,f=I(t.tempAesKey,t.tempAesIv,n.encrypted_answer),u=f.slice(0,20),h=f.slice(20),v=D(new Uint8Array(h).buffer,{schema:"mtproto"}),b=R(v,"Server_DH_inner_data");if(!p(u,sha1.array(h.slice(0,v.offset))))throw"Check server DH params hash error";if("server_DH_inner_data"!=b._)throw"Server DH inner data error";if(!p(t.initNonce,b.nonce))throw"Nonce not compare";if(!p(t.serverNonce,b.server_nonce))throw"Server nonce not compare";if(a=b.server_time,o=a-Math.floor(+new Date/1e3),TGInit.setStorage("server_time_offset",o),O=[0,0],W=o,!function(e,r,t){var n=g(r);if(3!=e||"c71caeb9c6b1c9048e6c522f70f13f73980d40238e3e21c14934d037563d930f48198a0aa7c14058229493d22530f4dbfa336f6e0ac925139543aed44cce7c3720fd51f69458705ac68cd4fe6b6b13abdc9746512969328454f18faf8c595f642477fe96bb2a941d5bcd1d4ac8cc49880708fa9b378e3c4f3a9060bee67cf9a4a4a695811051907e162753b56b0f6b410dba74d8a84b2a14b3144e0ef1284754fd17ed950d5965b4b9dd46582db1178d169c6bc465b0d6ff9ca3928fef5b9ae4e418fc15e83ebea0f87fa9ff5eed70050ded2849f47bf959d956850ce929851f0d8115f635b105ee2e4e15d04b2454bf6f4fadf034b10403119cd8e3b92fcc5b"!=n)return!1;var s=bigInt(g(t),16),a=bigInt(n,16);if(s.compare(bigInt.one)<=0)return!1;if(s.compare(a.prev())>=0)return!1;var o=bigInt[2].pow(1984);return!(s.compare(o)<0)&&!(s.compare(a.subtract(o))>=0)}(b.g,b.dh_prime,b.g_a))throw"Verify DH params error";return t.g=b.g,t.gA=b.g_a,t.dhPrime=b.dh_prime,t.retryId=0,function e(r,t){var n=i();return Promise.resolve().then((function(){t.b=l(256);var e=d(t.g.toString(16)),n=V(e,t.b,y(t.dhPrime)),s=F("Client_DH_Inner_Data",{_:"client_DH_inner_data",nonce:t.initNonce,server_nonce:t.serverNonce,retry_id:[0,t.retryId],g_b:c(n)},"mtproto"),a=sha1.array(s).concat(Array.from(new Uint8Array(s))),o=z("set_client_DH_params",{nonce:t.initNonce,server_nonce:t.serverNonce,encrypted_data:c(S(t.tempAesKey,t.tempAesIv,a))},"mtproto");return r.send(o,!0)})).then((function(s){var a=R(s.tl,"Set_client_DH_params_answer");if(!a)throw"DH generation fail";if(!p(t.initNonce,a.nonce))throw"Nonce not compare";if(!p(t.serverNonce,a.server_nonce))throw"Server nonce not compare";if("dh_gen_retry"==a._)return t.retryId++,void n.resolve(e(r,t));var o=V(y(t.gA),t.b,y(t.dhPrime)),i=sha1.array(o),c=i.slice(0,8),f=sha1.array(t.newNonce.concat([1],c)).slice(-16);if(!p(f,a.new_nonce_hash1))throw"New nonce hash not compare";t.authKey=o,t.authKeyId=i.slice(-8),t.serverSalt=w(t.newNonce.slice(0,8),t.serverNonce.slice(0,8)),n.resolve({authKey:o,authKeyId:i.slice(-8),serverSalt:w(t.newNonce.slice(0,8),t.serverNonce.slice(0,8))})})).catch((function(e){console.error(e)})),n.promise}(e,t)})).then((function(t){TGInit.setStorage("auth_key_".concat(e.dcId),v(t.authKey)),TGInit.setStorage("auth_key_id_".concat(e.dcId),v(t.authKeyId)),TGInit.setStorage("server_salt_".concat(e.dcId),v(t.serverSalt)),r.resolve()})).catch((function(e){console.error(e)})),r.promise},Z=function(e){var r=i();return(TGInit.getStorage("auth_key_".concat(e.dcId))?Promise.resolve.bind(Promise):Q)(e).then((function(){var t=TGInit.getStorage("auth_key_".concat(e.dcId)),n=TGInit.getStorage("auth_key_id_".concat(e.dcId)),s=TGInit.getStorage("server_salt_".concat(e.dcId));e.setAuthData(t,n,s),r.resolve()})),r.promise},X=[],J=[1145128264,1414745936,542393671,1230262351,3722304989,4008636142],Y=["pluto","venus","aurora","vesta","flora"],$=function(){function e(r,t){var n=this;!function(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}(this,e);var s,a=this;this.dcId=r,this.sendedMessages={},this.lastActivity=Date.now();try{s=new WebSocket("ws://".concat(Y[r-1],".web.telegram.org:443/apiws"),["binary"])}catch(e){}s.binaryType="arraybuffer",s.onopen=function(){a.handshake(),Z(a).then((function(){t(a)}))},s.onmessage=function(e){a.handleMessage(e.data)},s.onclose=function(e){console.log("WS close",e),e.wasClean||(delete X[n.dcId],ne(n.dcId,n.dcId==A))},s.onerror=function(e){console.log("WS error",e)},this.socket=s}var r,t,n;return r=e,(t=[{key:"updateSession",value:function(){this.seqNo=0,this.sessionId=l(8)}},{key:"nextSeqNo",value:function(){var e=2*this.seqNo;return e++,this.seqNo++,e}},{key:"applyServerSalt",value:function(e){this.serverSalt=d(e),TGInit.setStorage("server_salt_".concat(this.dcId),e)}},{key:"setAuthData",value:function(e,r,t){this.authKey=new Uint8Array(d(e)),this.authKeyId=new Uint8Array(d(r)),this.applyServerSalt(t),this.updateSession(),this.needInitConnection=!0}},{key:"sendToSocket",value:function(e,r){if(r)this.socket.send(e);else{var t,n=e.byteLength/4;n<127?t=Uint8Array.from([n]):(t=new Uint8Array(4)).set([127,n>>0&255,n>>8&255,n>>16&255]);var s=new Uint8Array(e),a=new ArrayBuffer(t.byteLength+s.byteLength),o=new Uint8Array(a);o.set(t),o.set(s,t.byteLength),this.socket.send(this.encryptor(o))}}},{key:"send",value:function(e,r,t){this.lastActivity=Date.now();var n=e._resType;this.needInitConnection&&(e=z("invokeWithLayer",{layer:105,query:z("initConnection",{api_id:832266,device_model:"Unknown",system_version:"Unknown",app_version:"0.0.1",lang_code:"en",lang_pack:"",system_lang_code:"en",query:e})}),this.needInitConnection=!1);var s,a,o=e.byteLength,f=new Uint8Array(e),u=D(),y=(s=+new Date,a=[Math.floor(s/1e3)+W,s%1e3<<21|h(65535)<<3|4],(O[0]>a[0]||O[0]==a[0]&&O[1]>=a[1])&&(a=[O[0],O[1]+4]),O=a,N(a[0],a[1]));this.serverSalt&&!t&&(this.sendedMessages[y]={id:y,body:e,defer:i(),waitResult:!r,resType:n}),this.serverSalt?(K(u,this.serverSalt,64),K(u,this.sessionId,64),B(u,y),C(u,this.nextSeqNo())):(B(u,[0,0]),B(u,y)),C(u,o);var v=j(u),g=v.byteLength,p=new Uint8Array(v),m=(15&-o)+16*(h(15)+1),_=new ArrayBuffer(g+o+m),w=new Uint8Array(_);if(w.set(p),w.set(f,g),w.set(l(m),g+o),this.serverSalt){var A=b(this.authKey.subarray(88,120),_),I=sha256(c(new Uint8Array(A))),U=new Uint8Array(d(I)).subarray(8,24),k=T(this.authKey,U),V=S(k[0],k[1],Array.from(w)),q=D(V.byteLength+256);return K(q,this.authKeyId,64),K(q,U,128),x(q,V,!0),this.sendToSocket(j(q)),t?null:this.sendedMessages[y].defer.promise}return this.sendToSocket(_),this.plainResponseDefer=i(),this.plainResponseDefer.promise}},{key:"handshake",value:function(){for(var e=new ArrayBuffer(64),r=new Uint32Array(e),t=new Uint8Array(e);t.set(l(64)),239==t[0]||J.includes(r[0])||0==r[1];);r.set([4025479151],14);var n=t.slice(8,40),s=t.slice(40,56),a=Uint8Array.from(t).reverse(),o=a.slice(8,40),i=a.slice(40,56);this.encryptor=function(e,r){var t=new aesjs.Counter;t.setBytes(r);var n=new aesjs.ModeOfOperation.ctr(e,t);return function(e){return n.encrypt(new Uint8Array(e))}}(n,s),this.decryptor=function(e,r){var t=new aesjs.Counter;t.setBytes(r);var n=new aesjs.ModeOfOperation.ctr(e,t);return function(e){return n.decrypt(new Uint8Array(e))}}(o,i);var c=this.encryptor(e),f=new Uint8Array(c);t.set(f.slice(56,64),56),this.sendToSocket(e,!0)}},{key:"sendMsgsAck",value:function(e){this.send(F("MsgsAck",{_:"msgs_ack",msg_ids:[e]},"mtproto"),!0,!0)}},{key:"processMessage",value:function(e,r){var t=this;if("bad_server_salt"==r._){this.applyServerSalt(v(r.new_server_salt._bytes));var n=this.sendedMessages[r.bad_msg_id];null!=n&&(n.defer.resolve(this.send(n.body)),delete this.sendedMessages[r.bad_msg_id])}"new_session_created"==r._&&(this.applyServerSalt(v(r.server_salt._bytes)),this.sendMsgsAck(e)),"msgs_ack"==r._&&r.msg_ids.forEach((function(e){t.sendedMessages[e]&&!t.sendedMessages[e].waitResult&&delete t.sendedMessages[e]})),"rpc_result"==r._&&this.sendedMessages[r.req_msg_id]&&(this.sendedMessages[r.req_msg_id].defer.resolve(r.result),delete this.sendedMessages[r.req_msg_id])}},{key:"handleMessage",value:function(e){this.lastActivity=Date.now();var r=this.decryptor(e).buffer,t=new Uint8Array(r),n=1;if(127==t[0]&&(n=4),this.serverSalt){var s=D(t.slice(n).buffer),a=L(s,64,!1);if(p(this.authKeyId,a)){var o=L(s,128,!0),i=E(s,!0),f=T(this.authKey,o,!0),u=I(f[0],f[1],c(i)),h=D(u.buffer),l=(L(h,64,!1),L(h,64,!1)),d=G(h);if(P(h),p(this.sessionId,l)){var y=P(h),v=E(h,!0,y),g=D(Uint8Array.from(v).buffer,{schema:"mtproto"}),b=R(g,"",this.sendedMessages);if(b)if(console.log(b),b._&&"msg_container"==b._)for(var m=0,_=b.messages.length;m<_;m++)this.processMessage(b.messages[m].msg_id,b.messages[m].body);else this.processMessage(d,b)}else console.error("Bad session id from server")}else console.error("Received error "+new Int32Array(t.slice(n).buffer)[0])}else if(this.plainResponseDefer){var w=D(t.slice(n).buffer,{schema:"mtproto"}),A=G(w),S=G(w),U=P(w);this.plainResponseDefer.resolve({authKeyId:A,msgId:S,msgLength:U,tl:w}),this.plainResponseDefer=null}}}])&&u(r.prototype,t),n&&u(r,n),e}(),ee=!1,re=function(){ae(z("ping",{ping_id:[h(4294967295),h(4294967295)]},"mtproto"))},te={},ne=function(e,r){return te[e]||(te[e]=i()),!r&&A||(A=e),X[e]?te[e].resolve(X[e]):new $(e,(function(r){X[e]=r,te[e].resolve(r),ee||(ee=!0,setInterval(re,6e4))})),te[e].promise},se=function(e){e!=A&&(X[e].socket.close(1e3),delete X[e],delete te[e])},ae=function(e,r){return X[r=r||A].send(e)};setInterval((function(){var e=Date.now(),r=[];for(var t in X){if(t!=A)e-X[t].lastActivity>6e4&&r.push(t)}r.forEach((function(e){se(e)}))}),1e4);var oe={sendCode:function(e){var r=i(),t=z("auth.sendCode",{phone_number:e,api_id:832266,api_hash:"efdc90dbf343a65bb4fba668f6e7d3a3",settings:{}});return ae(t).then((function(e){if(303==e.error_code){var r=parseInt(e.error_message.split("_")[2]),n=A;return TGInit.setStorage("nearest_dc",r),ne(r,!0).then((function(e){return se(n),ae(t)}))}return e})).then((function(e){e.error_message?r.resolve({err:e.error_message}):r.resolve({hash:e.phone_code_hash,codeLength:e.type.length})})),r.promise},signIn:function(e,r,t){var n=i();return ae(z("auth.signIn",{phone_number:e,phone_code_hash:r,phone_code:t})).then((function(e){if("auth.authorizationSignUpRequired"==e._){var r="";e.terms_of_service&&e.terms_of_service.text&&(r=e.terms_of_service.text),n.resolve({next:"reg",termOfService:r})}if(e.error_message){if("SESSION_PASSWORD_NEEDED"==e.error_message)return n.resolve({next:"pass"});n.resolve({err:e.error_message})}"auth.authorization"==e._&&(TGInit.setStorage("access_hash",v(e.user.access_hash._bytes)),TGInit.setStorage("user_id",e.user.id),n.resolve({next:"done"}))})),n.promise},signUp:function(e,r,t,n){var s=i();return ae(z("auth.signUp",{phone_number:e,phone_code_hash:r,first_name:t,last_name:n})).then((function(e){e.error_message&&s.resolve({err:e.error_message}),"auth.authorization"==e._&&(TGInit.setStorage("access_hash",v(e.user.access_hash._bytes)),TGInit.setStorage("user_id",e.user.id),s.resolve({next:"done"}))})),s.promise}},ie={getUsers:function(e){},getCurrentUser:function(){return ae(z("users.getUsers",{id:[{_:"inputUserSelf"}]}))}},ce={getDialogs:function(){return ae(z("messages.getDialogs",{offset_date:0,offset_id:0,offset_peer:{_:"inputPeerEmpty"},limit:100,hash:0}))},getHistory:function(e){return ae(z("messages.getHistory",{peer:e,offset_date:0,offset_id:0,add_offset:0,limit:20,max_id:0,min_id:0,hash:0}))}},fe={uploadProfilePhoto:function(e){return ae(z("photos.uploadProfilePhoto",{file:e}))},uploadFile:function(e){var r=i(),t=e.size>=10485760,n=262144;e.size>67108864?n=524288:e.size<102400&&(n=32768);var s=Math.ceil(e.size/n),a=[h(4294967295),h(4294967295)],o={_:t?"inputFileBig":"inputFile",id:a,parts:s,name:e.name,md5_checksum:""},c=0,f=0;return function i(){var u=new FileReader,h=e.slice(f,f+n);u.onloadend=function(){ae(z(t?"upload.saveBigFilePart":"upload.saveFilePart",{file_id:a,file_part:c,file_total_parts:s,bytes:u.result})).then((function(e){f+=n,++c>=s?r.resolve(o):i()}))},u.readAsArrayBuffer(h)}(),r.promise}},ue=!1,he=!1,le=i();return e.auth=oe,e.init=function(){if(he)return Promise.resolve();if(ue)return le.promise;ue=!0;var e=parseInt(TGInit.getStorage("nearest_dc"))||1;return ne(e,!0).then((function(e){if(!TGInit.getStorage("nearest_dc"))return e.send(z("help.getNearestDc"))})).then((function(r){if(!r)return le.resolve();var t=r.nearest_dc;TGInit.setStorage("nearest_dc",t),se(e),ne(t,!0).then((function(e){he=!0,le.resolve()}))})),le.promise},e.initAllDc=function(){[1,2,3,4,5].forEach((function(e){TGInit.getStorage("auth_key_".concat(e))||ne(e).then((function(r){se(e)}))}))},e.messages=ce,e.users=ie,e.utils=fe,e}({});
