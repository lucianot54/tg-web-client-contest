var tgProto=function(e){"use strict";const t=e=>((e=parseInt(e))<0&&(e+=4294967296),e),s=e=>(e>2147483647&&(e-=4294967296),e),n=/([A-z0-9_\.]+)(#([a-f0-9]+))?/,r=/([A-z0-9_]+):([A-z0-9_\#\?\.<>%\!]+)/g,a=/= (.+);/,i=e=>{const t=[],i=[];let o=!1;e.split(";").forEach(e=>{if(""==e)return void(o=!0);e+=";";const c=n.exec(e);if(!c)return;const d={id:parseInt(c[3],16),name:c[1]},f=[];let l;for(;null!==(l=r.exec(e));)f.push({name:l[1],type:l[2]});const p=a.exec(e)[1];o?i.push({id:s(d.id),method:d.name,params:f,type:p}):t.push({id:s(d.id),predicate:d.name,params:f,type:p})});const c={},d={},f={};for(let e=0,s=t.length;e<s;e++)c[t[e].id]=e,d[t[e].type]=e,f[t[e].predicate]=e;const l={};for(let e=0,t=i.length;e<t;e++)l[i[e].method]=e;return{constructors:t,cIdIndexes:c,cTypeIndexes:d,cPredIndexes:f,methods:i,mIndexes:l}},o=i("resPQ#05162463 nonce:int128 server_nonce:int128 pq:bytes server_public_key_fingerprints:Vector<long> = ResPQ;p_q_inner_data#83c95aec pq:bytes p:bytes q:bytes nonce:int128 server_nonce:int128 new_nonce:int256 = P_Q_inner_data;server_DH_params_fail#79cb045d nonce:int128 server_nonce:int128 new_nonce_hash:int128 = Server_DH_Params;server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:bytes = Server_DH_Params;server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:bytes g_a:bytes server_time:int = Server_DH_inner_data;client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:bytes = Client_DH_Inner_Data;dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;dh_gen_retry#46dc1fb9 nonce:int128 server_nonce:int128 new_nonce_hash2:int128 = Set_client_DH_params_answer;dh_gen_fail#a69dae02 nonce:int128 server_nonce:int128 new_nonce_hash3:int128 = Set_client_DH_params_answer;rpc_result#f35c6d01 req_msg_id:long result:Object = RpcResult;rpc_error#2144ca19 error_code:int error_message:string = RpcError;pong#347773c5 msg_id:long ping_id:long = Pong;new_session_created#9ec20908 first_msg_id:long unique_id:long server_salt:long = NewSession;msg_container#73f1f8dc messages:vector<%Message> = MessageContainer;message msg_id:long seqno:int bytes:int body:Object = Message;gzip_packed#3072cfa1 packed_data:bytes = Object;msgs_ack#62d6b459 msg_ids:Vector<long> = MsgsAck;bad_server_salt#edab447b bad_msg_id:long bad_msg_seqno:int error_code:int new_server_salt:long = BadMsgNotification;;req_pq#60469778 nonce:int128 = ResPQ;req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:bytes q:bytes public_key_fingerprint:long encrypted_data:bytes = Server_DH_Params;set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:bytes = Set_client_DH_params_answer;ping#7abe77ec ping_id:long = Pong");let c;const d=(e,t)=>{const s=e&&void 0!==e.byteLength;s||(t=e),t=t||{};const n=s?e.byteLength:t.length||2048,r=t.schema||"api";let a;return a=s?e:new ArrayBuffer(n),{buffer:a,intView:new Int32Array(a),byteView:new Uint8Array(a),length:n,schema:r,offset:0}},f=(e,t)=>{if(e.offset+t<e.length)return;const s=4*Math.ceil(Math.max(2*e.length,e.offset+t+16)/4),n=e.intView;e.length=s,e.buffer=new ArrayBuffer(s),e.intView=new Int32Array(e.buffer),e.byteView=new Uint8Array(e.buffer),e.intView.set(n)},l=(e,t)=>{f(e,4),e.intView[e.offset/4]=t,e.offset+=4},p=e=>{const t=e.intView[e.offset/4];return e.offset+=4,t},g=(e,t)=>{l(e,t[0]),l(e,t[1])},_=e=>[p(e),p(e)],h=(e,t,s)=>{t instanceof ArrayBuffer&&(t=new Uint8Array(t));const n=t.length;s%32||8*n!=s||(f(e,n),e.byteView.set(t,e.offset),e.offset+=n)},u=(e,t,s)=>{const n=t/8;if(s){const t=e.byteView.subarray(e.offset,e.offset+n);return e.offset+=n,t}const r=[];for(let t=0;t<n;t++)r.push(e.byteView[e.offset++]);return r},y=(e,t,s)=>{t instanceof ArrayBuffer?t=new Uint8Array(t):t||(t=[]);const n=t.byteLength||t.length;for(f(e,n+8),s||(n<253?e.byteView[e.offset++]=n:(e.byteView[e.offset++]=254,e.byteView[e.offset++]=255&n,e.byteView[e.offset++]=(65280&n)>>8,e.byteView[e.offset++]=(16711680&n)>>16)),e.byteView.set(t,e.offset),e.offset+=n;e.offset%4;)e.byteView[e.offset++]=0},w=(e,t,s)=>{t?s=s||e.byteView.byteLength-e.offset:254==(s=e.byteView[e.offset++])&&(s=e.byteView[e.offset++]|e.byteView[e.offset++]<<8|e.byteView[e.offset++]<<16);const n=e.byteView.subarray(e.offset,e.offset+s);for(e.offset+=s;e.offset%4;)e.offset++;return n},m=(e,s,n)=>{switch(s){case"#":case"int":return l(e,n);case"long":return g(e,n);case"int128":return h(e,n,128);case"int256":return h(e,n,256);case"int512":return h(e,n,512);case"string":return((e,t)=>{t=t||"";const s=(t=unescape(encodeURIComponent(t))).length;f(e,s+8),s<253?e.byteView[e.offset++]=s:(e.byteView[e.offset++]=254,e.byteView[e.offset++]=255&s,e.byteView[e.offset++]=(65280&s)>>8,e.byteView[e.offset++]=(16711680&s)>>16);for(let n=0;n<s;n++)e.byteView[e.offset++]=t.charCodeAt(n);for(;e.offset%4;)e.byteView[e.offset++]=0})(e,n);case"bytes":return y(e,n);case"double":return((e,t)=>{const s=new ArrayBuffer(8),n=new Int32Array(s);new Float64Array(s)[0]=t,l(e,n[0]),l(e,n[1])})(e,n);case"Bool":return((e,t)=>{l(e,t?2574415285:3162085175)})(e,n);case"!X":return y(e,new Uint8Array(n),!0);case"true":return}if(Array.isArray(n)){"Vector"==s.substr(0,6)&&l(e,481674261);const t=s.substr(7,s.length-8);return l(e,n.length),void n.forEach(s=>{m(e,t,s)})}if("object"==typeof n){let r="%"==s.charAt(0);r&&(s=s.substr(1));const a="api"==e.schema?c:o,i=n._;let d=a.constructors[a.cPredIndexes[i]];if(d||(d=a.constructors[a.cTypeIndexes[s]]),!d)return;i==s&&(r=!0),r||l(e,t(d.id));for(let t=0,s=d.params.length;t<s;t++){const s=d.params[t];let r=s.type;if(r.includes("?")){const e=r.split("?"),t=e[0].split(".");if(!(n[t[0]]&1<<t[1]))continue;r=e[1]}m(e,r,n[s.name])}}},b=async(e,s,n)=>{switch(s=s||""){case"#":case"int":return p(e);case"long":return _(e);case"int128":return u(e,128,!1);case"int256":return u(e,256,!1);case"int512":return u(e,512,!1);case"string":return(e=>{let t=e.byteView[e.offset++];254==t&&(t=e.byteView[e.offset++]|e.byteView[e.offset++]<<8|e.byteView[e.offset++]<<16);let s,n="";for(let s=0;s<t;s++)n+=String.fromCharCode(e.byteView[e.offset++]);for(;e.offset%4;)e.offset++;try{s=decodeURIComponent(escape(n))}catch(e){s=n}return s})(e);case"bytes":return w(e);case"double":return(e=>{const t=new ArrayBuffer(8),s=new Int32Array(t),n=new Float64Array(t);return s[0]=p(e),s[1]=p(e),n[0]})(e);case"Bool":return await(async e=>{const s=t(p(e));return 2574415285==s||3162085175!=s&&(e.offset-=4,await b(e,"Object"))})(e);case"true":return!0}if("vector"==s.substr(0,6).toLowerCase()){if("V"==s.charAt(0)){const t=p(e);if(812830625==t){const t=await tgMain.callWorker("gunzip",w(e)),r=d(t.buffer);return await b(r,s,n)}if(481674261!=t)return}const t=p(e),r=[];if(t>0){const a=s.substr(7,s.length-8);for(let s=0;s<t;s++)r.push(await b(e,a,n))}return r}const r="api"==e.schema?c:o;let a;if("%"==s.charAt(0)){const t=s.substr(1);if(a=r.constructors[r.cTypeIndexes[t]],!a)return e.schemaChanged?void 0:(e.schema="proto"==e.schema?"api":"proto",e.schemaChanged=!0,await b(e,s,n))}else if(s.charAt(0)>=97&&s.charAt(0)<=122){if(a=r.constructors[r.cPredIndexes[s]],!a)return e.schemaChanged?void 0:(e.schema="proto"==e.schema?"api":"proto",e.schemaChanged=!0,await b(e,s,n))}else{const t=p(e);if(812830625==t){const t=await tgMain.callWorker("gunzip",w(e)),r=d(t.buffer);return await b(r,s,n)}if(a=r.constructors[r.cIdIndexes[t]],!a){if(e.schemaChanged)return;{e.offset-=4,e.schema="proto"==e.schema?"api":"proto",e.schemaChanged=!0;const t=await b(e,s,n);return e.schema="proto"==e.schema?"api":"proto",e.schemaChanged=!1,t}}}let i=a.predicate;const f={_:i,_type:a.type};for(let t=0,s=a.params.length;t<s;t++){const s=a.params[t];let r=s.type;if(r.includes("?")){const e=r.split("?"),t=e[0].split(".");if(!(f[t[0]]&1<<t[1]))continue;r=e[1]}"rpc_result"==i&&"result"==s.name&&n[f.req_msg_id.toString()]&&(r=n[f.req_msg_id.toString()].body._resType);const o=await b(e,r,n);f[s.name]=o}return f},v=e=>{const t=new ArrayBuffer(e.offset),s=new Int32Array(t);return s.set(e.intView.subarray(0,e.offset/4)),s.buffer},M=(e,s,n)=>{"api"==(n=n||"api")&&console.log("serializeMethod",e,s);const r=d({schema:n}),a=((e,s,n)=>{const r="api"==e.schema?c:o,a=r.methods[r.mIndexes[s]];l(e,t(a.id));for(let t=0,s=a.params.length;t<s;t++){const s=a.params[t];let r=s.type;if(r.includes("?")){const e=r.split("?"),t=e[0].split(".");if(!(n[t[0]]&1<<t[1]))continue;r=e[1]}m(e,r,n[s.name])}return a.type})(r,e,s),i=v(r);return i._resType=a,i},A=(e,t,s)=>{const n=d({schema:s=s||"api"});return m(n,e,t),v(n)},S=e=>Math.floor(Math.random()*e),k=()=>{const e={};return e.promise=new Promise((t,s)=>{e.resolve=t,e.reject=s}),e},I=e=>{const t=new Uint8Array(e);return crypto.getRandomValues(t),t},q=e=>(e.length%2&&(e="0"+e),new Uint8Array(e.match(/.{1,2}/g).map(e=>parseInt(e,16)))),D=e=>e.reduce((e,t)=>e+t.toString(16).padStart(2,"0"),""),N=(e,t)=>e.toString()==t.toString();let U=[0,0],C=parseInt(tgMain.getStorage("sto"))||0;const V=tgMain.isTestMode,P=(e,t)=>new Uint8Array(e.length).map((s,n)=>e[n]^t[n]),W=async(e,t)=>{t.b=I(256);const s=q(t.g.toString(16)),n=await tgMain.callWorker("bytesModPow",{x:s,y:t.b,m:t.dhPrime}),r=A("Client_DH_Inner_Data",{_:"client_DH_inner_data",nonce:t.initNonce,server_nonce:t.serverNonce,retry_id:[0,t.retryId],g_b:n},"proto"),a=new Uint8Array([...await tgMain.callWorker("sha1",r),...new Uint8Array(r)]),i=M("set_client_DH_params",{nonce:t.initNonce,server_nonce:t.serverNonce,encrypted_data:await tgMain.callWorker("cryptAesIge",{key:t.tempAesKey,iv:t.tempAesIv,data:a})},"proto"),o=await e.send(i,!0),c=await b(o.tl,"Set_client_DH_params_answer");if(!c)throw"DH generation fail";if(!N(t.initNonce,c.nonce))throw"Nonce not compare";if(!N(t.serverNonce,c.server_nonce))throw"Server nonce not compare";if("dh_gen_retry"==c._)return t.retryId++,await W(e,t);const d=new Uint8Array(await tgMain.callWorker("bytesModPow",{x:t.gA,y:t.b,m:t.dhPrime})),f=await tgMain.callWorker("sha1",d),l=f.slice(0,8),p=(await tgMain.callWorker("sha1",new Uint8Array([...t.newNonce,1,...l]))).slice(-16);if(!N(p,c.new_nonce_hash1))throw"New nonce hash not compare";return t.authKey=d,t.authKeyId=f.slice(-8),t.serverSalt=P(t.newNonce.slice(0,8),t.serverNonce.slice(0,8)),{authKey:d,authKeyId:f.slice(-8),serverSalt:P(t.newNonce.slice(0,8),t.serverNonce.slice(0,8))}},H=async e=>{const t={};t.initNonce=I(16);const s=M("req_pq",{nonce:t.initNonce},"proto"),n=await e.send(s),r=await b(n.tl,"ResPQ");if(t.pq=r.pq,t.serverNonce=r.server_nonce,!N(t.initNonce,r.nonce))throw"Nonce not compare";const a=await tgMain.callWorker("factorize",r.pq);t.p=a.p,t.q=a.q,t.newNonce=I(32);const i=A("P_Q_inner_data",{_:"p_q_inner_data",pq:t.pq,p:t.p,q:t.q,nonce:t.initNonce,server_nonce:t.serverNonce,new_nonce:t.newNonce},"proto");let o=M("req_DH_params",{nonce:t.initNonce,server_nonce:t.serverNonce,p:t.p,q:t.q,public_key_fingerprint:[1827171105,-1011602686],encrypted_data:await tgMain.callWorker("rsaEncrypt",{key:"c150023e2f70db7985ded064759cfecf0af328e69a41daf4d6f01b538135a6f91f8f8b2a0ec9ba9720ce352efcf6c5680ffc424bd634864902de0b4bd6d49f4e580230e3ae97d95c8b19442b3c0a10d8f5633fecedd6926a7f6dab0ddb7d457f9ea81b8465fcd6fffeed114011df91c059caedaf97625f6c96ecc74725556934ef781d866b34f011fce4d835a090196e9a5f0e4449af7eb697ddb9076494ca5f81104a305b6dd27665722c46b60e5df680fb16b210607ef217652e60236c255f6a28315f4083a96791d7214bf64c1df4fd0db1944fb26a2a57031b32eee64ad15a8ba68885cde74a5bfc920f6abf59ba5c75506373e7130f9042da922179251f",data:i})},"proto");const c=await e.send(o),f=await b(c.tl,"Server_DH_Params");if(!f)throw"Server DH params error";if(!N(t.initNonce,f.nonce))throw"Nonce not compare";if(!N(t.serverNonce,f.server_nonce))throw"Server nonce not compare";const l=new Uint8Array([...t.serverNonce,...t.newNonce]);t.tempAesKey=new Uint8Array([...await tgMain.callWorker("sha1",new Uint8Array([...t.newNonce,...t.serverNonce])),...(await tgMain.callWorker("sha1",l)).slice(0,12)]),t.tempAesIv=new Uint8Array([...(await tgMain.callWorker("sha1",l)).slice(12),...await tgMain.callWorker("sha1",new Uint8Array([...t.newNonce,...t.newNonce])),...t.newNonce.slice(0,4)]);const p=await tgMain.callWorker("cryptAesIge",{type:1,key:t.tempAesKey,iv:t.tempAesIv,data:f.encrypted_answer}),g=p.slice(0,20),_=p.slice(20),h=d(new Uint8Array(_).buffer,{schema:"proto"}),u=await b(h,"Server_DH_inner_data"),y=await tgMain.callWorker("sha1",_.slice(0,h.offset));if(!N(g,y))throw"Check server DH params hash error";if("server_DH_inner_data"!=u._)throw"Server DH inner data error";if(!N(t.initNonce,u.nonce))throw"Nonce not compare";if(!N(t.serverNonce,u.server_nonce))throw"Server nonce not compare";if((e=>{const t=e-Math.floor(+new Date/1e3);tgMain.setStorage("sto",t),U=[0,0],C=t})(u.server_time),!await tgMain.callWorker("verifyDhParams",{g:u.g,dhPrime:u.dh_prime,gA:u.g_a}))throw"Verify DH params error";t.g=u.g,t.gA=u.g_a,t.dhPrime=u.dh_prime,t.retryId=0;const w=await W(e,t),m=`${e.dcId}${V?"t":""}`;tgMain.setStorage(`ak${m}`,D(w.authKey)),tgMain.setStorage(`aki${m}`,D(w.authKeyId)),tgMain.setStorage(`s${m}`,D(w.serverSalt))};let E,T,K={main:!1},x={};const $=()=>{tgMain.setStorage("us",JSON.stringify(T)),tgMain.setStorage("uc",JSON.stringify(x))},L=async()=>{const e=tgMain.getStorage("us");if(!e){const e=await pe(M("updates.getState"));return T={},T.pts=e.pts,T.qts=e.qts,T.seq=e.seq,T.date=e.date,x={},$(),K.main=!0,void(E=setTimeout(Q,9e5))}T=JSON.parse(e),x=JSON.parse(tgMain.getStorage("uc")),K.main=!0,Object.keys(x).forEach(e=>{K[e]=!0}),await Q()};let O,R;const B=()=>[4294967295*Math.random()-2147483648,4294967295*Math.random()-2147483648],j=async e=>{if(!K[e])return;K[e]=!1;const t=await pe(M("updates.getChannelDifference",{channel:{_:"inputChannel",channel_id:e,access_hash:x[e].ah},pts:x[e].pts,filter:{_:"channelMessagesFilterEmpty"},limit:20}));if("rpc_error"==t._)return await(s=500,new Promise(e=>{setTimeout(e,s)})),x[e].pts--,$(),K[e]=!0,j(e);var s;if(t.pts&&(x[e].pts=t.pts),$(),"updates.channelDifferenceEmpty"==t._)return void(K[e]=!0);if("updates.channelDifferenceTooLong"==t._)return K[e]=!0,x[e].pts=t.dialog.pts,$(),void Y(t);const n=t.other_updates;t.new_messages.forEach(e=>{n.push({_:"updateNewChannelMessage",message:e})}),K[e]=!0,J({_:"updates",users:t.users,chats:t.chats,updates:n},!0)},z=async()=>{if(!K.main)return;K.main=!1;const e=await pe(M("updates.getDifference",T));if(e.pts&&(T.pts=e.pts),e.date&&(T.date=e.date),e.seq&&(T.seq=e.seq),$(),"updates.differenceEmpty"==e._)return void(K.main=!0);if("updates.differenceTooLong"==e._)return K.main=!0,void z();Y(e);const t=e.intermediate_state||e.state;T.pts=t.pts,T.qts=t.qts,t.seq&&(T.seq=t.seq),T.date=t.date,$();const s=e.other_updates;e.new_messages.forEach(e=>{s.push({_:"updateNewMessage",message:e})}),e.new_encrypted_messages.forEach(e=>{s.push({_:"updateNewEncryptedMessage",message:e})}),K.main=!0,J({_:"updates",users:e.users,chats:e.chats,updates:s},!0),"updates.differenceSlice"==e._&&z()},Q=async()=>{await z(),x&&Object.keys(x).forEach(e=>{j(parseInt(e))})},J=(e,t)=>{if(!K.main)return;if(clearTimeout(E),E=setTimeout(Q,9e5),"updatesTooLong"==e._)return void Q();if("updateShortMessage"==e._||"updateShortChatMessage"==e._){const t=Object.assign({},e);t._="message",t.from_id=e.from_id?e.from_id:e.out?tgApp.userId:e.user_id,t.to_id={_:"updateShortChatMessage"==e._?"peerChat":"peerUser",_type:"Peer"},"updateShortChatMessage"==e._?t.to_id.chat_id=e.chat_id:t.to_id.user_id=e.out?e.user_id:tgApp.userId,e={_:"updateShort",date:t.date,update:{_:"updateNewMessage",message:t,pts:e.pts,pts_count:e.pts_count}}}if("updateShortSentMessage"==e._){const t=Object.assign({},e);t._="message",t.to_id=O,t.message=R,e={_:"updateShort",date:t.date,update:{_:"updateNewMessage",message:t,pts:e.pts,pts_count:e.pts_count}}}if("updateShort"==e._){const t=e.update,s=F(t);if("fill"==s){if(t._&&t._.includes("Channel")){let e=t.channel_id;if(!e){const s=t.message.to_id;e=s.chat_id||s.channel_id}j(e)}else z();return}if("skip"==s)return;return T.date=e.date,$(),void Y(e.update)}if(Y(e),t)return void e.updates.forEach(e=>{F(e,!0),Y(e)});const s=[];e.updates=e.updates.sort((e,t)=>{const s=e.pts||e.qts,n=t.pts||t.qts;return s||n?s&&!n?1:!s&&n?-1:e.qts&&t.qts?e.qts<t.qts?-1:e.qts>t.qts?1:0:e.pts&&t.pts?e.pts<t.pts?-1:e.pts>t.pts?1:!e.pts_count&&t.pts_count?1:e.pts_count&&!t.pts_count?-1:0:0:0});for(let t=0,n=e.updates.length;t<n;t++){const n=e.updates[t],r=F(n);if("fill"==r){if(n._&&n._.includes("Channel")){let e=n.channel_id;if(!e){const t=n.message.to_id;e=t.chat_id||t.channel_id}j(e)}else z();return}"skip"!=r&&s.push(n)}const n=e.seq_start||e.seq;if(n){const e=T.seq+1;if(e>n)return;if(e<n)return void Q()}s.forEach(e=>{Y(e)}),e.seq&&(T.seq=e.seq),T.date=e.date,$()},F=(e,t)=>{const s=e.qts;if(s){const e=T.qts+1;if(t)T.qts<e&&(T.qts=e);else{if(e>s)return"skip";if(e<s)return"fill";T.qts=e}}const n=e.pts;if(n)if(e._&&e._.includes("Channel")){let s=e.channel_id;if(!s){const t=e.message.to_id;s=t.chat_id||t.channel_id}if(!x[s])return"skip";const r=e.pts_count||0,a=x[s].pts+r;if(t)x[s].pts<a&&(x[s].pts=a);else{if(a>n)return"skip";if(a<n)return"fill";x[s].pts=n}}else{const s=e.pts_count||0,r=T.pts+s;if(t)T.pts<r&&(T.pts=r);else{if(r>n)return"skip";if(r<n)return"fill";T.pts=n}}return"ok"};let X={};const G=(e,t)=>{X[e]||(X[e]=[]),X[e].push(t)},Y=async e=>{if(X[e._])for(let t=0,s=X[e._].length;t<s;t++)await X[e._][t](e)};G("updatePtsChanged",()=>{tgMain.setStorage("us",null),K.main=!1,L()}),G("updateChannelTooLong",e=>{e.pts&&(x[e.channel_id].pts=e.pts,$()),j(e.channel_id)});const Z=tgMain.isTestMode;let ee=!0;const te=async(e,t,s)=>{const n=s?8:0,r=new Uint8Array(52),a=new Uint8Array(52);r.set(t,0),r.set(e.subarray(n,n+36),16);const i=await tgMain.callWorker("sha256",r);a.set(e.subarray(40+n,40+n+36),0),a.set(t,36);const o=await tgMain.callWorker("sha256",a),c=new Uint8Array(32),d=new Uint8Array(32);return c.set(i.subarray(0,8)),c.set(o.subarray(8,24),8),c.set(i.subarray(24,32),24),d.set(o.subarray(0,8)),d.set(i.subarray(8,24),8),d.set(o.subarray(24,32),24),[c,d]},se={};let ne;const re=[1145128264,1414745936,542393671,1230262351,3722304989,4008636142],ae=["pluto","venus","aurora","vesta","flora"];class ie{constructor(e,t,s){const n=this;this.dcId=e,this.sendedMessages={},this.lastActivity=Date.now();const r=new WebSocket(`ws://${ae[e-1]}.web.telegram.org:443${`/apiws${Z?"_test":""}`}`,["binary"]);r.binaryType="arraybuffer";let a=!0,i=!1;r.onopen=async()=>{await n.handshake();try{await(async e=>{tgMain.getStorage(`ak${e.dcId}${V?"t":""}`)||await H(e);const t=`${e.dcId}${V?"t":""}`,s=tgMain.getStorage(`ak${t}`),n=tgMain.getStorage(`aki${t}`),r=tgMain.getStorage(`s${t}`);e.setAuthData(s,n,r)})(n)}catch(e){return a=!1,console.log(e),i=!0,void r.close()}tgProto.onConnect&&this.dcId==ne&&tgProto.onConnect(),s(n),t&&Object.values(t).forEach(e=>{e.defer.resolve(this.send(e.body))})},r.onmessage=e=>{n.handleMessage(e.data)},r.onclose=async e=>{if(!e.wasClean||i){a&&tgProto.onDisconnect&&tgProto.onDisconnect();let e=t;se[this.dcId]&&(e=se[this.dcId].sendedMessages),delete se[this.dcId],fe(this.dcId,this.dcId==ne,e)}},this.socket=r}updateSession(){this.seqNo=0,this.sessionId=I(8)}nextSeqNo(){let e=2*this.seqNo;return e++,this.seqNo++,e}applyServerSalt(e){this.serverSalt=q(e),tgMain.setStorage(`s${this.dcId}${Z?"t":""}`,e)}setAuthData(e,t,s){this.authKey=new Uint8Array(q(e)),this.authKeyId=new Uint8Array(q(t)),this.applyServerSalt(s),this.updateSession(),this.needInitConnection=!0}async sendToSocket(e,t){if(t)return void this.socket.send(e);const s=e.byteLength/4;let n;s<127?n=Uint8Array.from([s]):(n=new Uint8Array(4),n.set([127,s>>0&255,s>>8&255,s>>16&255]));const r=new Uint8Array(e),a=new ArrayBuffer(n.byteLength+r.byteLength),i=new Uint8Array(a);i.set(n),i.set(r,n.byteLength),this.socket.send(await tgMain.callWorker("cryptAesCtr",{id:this.encryptionKeyId,data:i}))}async send(e,t,s){if(this.lastActivity=Date.now(),this.needInitConnection){if(!e._wrapped){const t=e._resType;(e=M("invokeWithLayer",{layer:108,query:M("initConnection",{api_id:832266,device_model:"Unknown",system_version:"Unknown",app_version:"0.0.1",lang_code:"en",lang_pack:"",system_lang_code:"en",query:e})}))._resType=t,e._wrapped=!0}this.needInitConnection=!1}const n=e.byteLength,r=new Uint8Array(e),a=d(),i=(()=>{const e=+new Date;let t=[Math.floor(e/1e3)+C,e%1e3<<21|S(65535)<<3|4];return(U[0]>t[0]||U[0]==t[0]&&U[1]>=t[1])&&(t=[U[0],U[1]+4]),U=t,[t[1],t[0]]})();this.serverSalt&&!s&&(this.sendedMessages[i.toString()]={id:i,body:e,defer:k(),waitResult:!t}),this.serverSalt?(h(a,this.serverSalt,64),h(a,this.sessionId,64),g(a,i),l(a,this.nextSeqNo())):(g(a,[0,0]),g(a,i)),l(a,n);const o=v(a),c=o.byteLength,f=new Uint8Array(o),p=(15&-n)+16*(S(15)+1);let _=new ArrayBuffer(c+n+p);const u=new Uint8Array(_);if(u.set(f),u.set(r,c),u.set(I(p),c+n),this.serverSalt){const e=new Uint8Array([...this.authKey.subarray(88,120),...u]),t=await tgMain.callWorker("sha256",e),n=new Uint8Array(t).subarray(8,24),r=await te(this.authKey,n),a=await tgMain.callWorker("cryptAesIge",{key:r[0],iv:r[1],data:u}),o=d(a.byteLength+256);return h(o,this.authKeyId,64),h(o,n,128),y(o,a,!0),await this.sendToSocket(v(o)),s?null:this.sendedMessages[i.toString()].defer.promise}return await this.sendToSocket(_),this.plainResponseDefer=k(),this.plainResponseDefer.promise}async handshake(){const e=new ArrayBuffer(64),t=new Uint32Array(e),s=new Uint8Array(e);for(;s.set(I(64)),239==s[0]||re.includes(t[0])||0==t[1];);t.set([4025479151],14);const n=s.slice(8,40),r=s.slice(40,56),a=Uint8Array.from(s).reverse(),i=a.slice(8,40),o=a.slice(40,56);this.encryptionKeyId=await tgMain.callWorker("importAesCtrData",{key:n,iv:r}),this.decryptionKeyId=await tgMain.callWorker("importAesCtrData",{key:i,iv:o});const c=await tgMain.callWorker("cryptAesCtr",{id:this.encryptionKeyId,data:e}),d=new Uint8Array(c);s.set(d.slice(56,64),56),await this.sendToSocket(e,!0)}sendMsgsAck(e){this.send(A("MsgsAck",{_:"msgs_ack",msg_ids:[e]},"proto"),!0,!0)}async processMessage(e,t){if("Updates"!=t._type)if("rpc_result"!=t._||"Updates"!=t.result._type){if("bad_server_salt"==t._){this.applyServerSalt(D(new Uint8Array(Int32Array.from(t.new_server_salt).buffer)));const e=this.sendedMessages[t.bad_msg_id.toString()];null!=e&&(e.defer.resolve(this.send(e.body)),delete this.sendedMessages[t.bad_msg_id.toString()])}if("new_session_created"==t._&&(this.applyServerSalt(D(new Uint8Array(Int32Array.from(t.server_salt).buffer))),this.sendMsgsAck(e),Q()),"msgs_ack"==t._&&t.msg_ids.forEach(e=>{this.sendedMessages[e.toString()]&&!this.sendedMessages[e.toString()].waitResult&&delete this.sendedMessages[e.toString()]}),"rpc_result"==t._){if(303==t.result.error_code){const e=parseInt(t.result.error_message.split("_")[2]),s=ne;return tgMain.setStorage("nd",e),await fe(e,!0,this.sendedMessages),void le(s)}if(401==t.result.error_code&&"SESSION_PASSWORD_NEEDED"!=t.result.error_message)return void tgProto.logOut();this.sendedMessages[t.req_msg_id.toString()]&&("rpc_error"==t.result._&&console.log("rpc_error",t,this.sendedMessages[t.req_msg_id.toString()]),this.sendedMessages[t.req_msg_id.toString()].defer.resolve(t.result),delete this.sendedMessages[t.req_msg_id.toString()])}"rpc_error"==t._&&this.sendedMessages[t.req_msg_id.toString()]&&(console.log("rpc_error",t,this.sendedMessages[t.req_msg_id.toString()]),delete this.sendedMessages[t.req_msg_id.toString()])}else J(t.result);else J(t)}async handleMessage(e){this.lastActivity=Date.now();const t=await tgMain.callWorker("cryptAesCtr",{id:this.decryptionKeyId,data:e});let s=1;if(127==t[0]&&(s=4),!this.serverSalt){if(this.plainResponseDefer){const e=d(t.slice(s).buffer,{schema:"proto"}),n=_(e),r=_(e),a=p(e);this.plainResponseDefer.resolve({authKeyId:n,msgId:r,msgLength:a,tl:e}),this.plainResponseDefer=null}return}const n=d(t.slice(s).buffer),r=u(n,64,!1);if(!N(this.authKeyId,r))return void console.log("Received error "+new Int32Array(t.slice(s).buffer)[0]);const a=u(n,128,!0),i=w(n,!0),o=await te(this.authKey,a,!0),c=await tgMain.callWorker("cryptAesIge",{type:1,key:o[0],iv:o[1],data:i}),f=d(c.buffer);u(f,64,!1);const l=u(f,64,!1),g=_(f);if(p(f),!N(this.sessionId,l))return void console.log("Bad session id from server");const h=p(f),y=w(f,!0,h),m=d(Uint8Array.from(y).buffer,{schema:"proto"}),v=await b(m,"",this.sendedMessages);if(v)if(console.log(v),ee)if(v._&&"msg_container"==v._)for(let e=0,t=v.messages.length;e<t;e++)await this.processMessage(v.messages[e].msg_id,v.messages[e].body);else await this.processMessage(g,v);else console.log("not handle");else Q()}}let oe=!1;const ce=()=>{pe(M("ping",{ping_id:[S(4294967295),S(4294967295)]},"proto"))},de={},fe=(e,t,s)=>(de[e]||(de[e]=k()),!t&&ne||(ne=e),se[e]?de[e].resolve(se[e]):new ie(e,s,t=>{se[e]=t,de[e]&&de[e].resolve(t),oe||(oe=!0,setInterval(ce,6e4))}),de[e].promise),le=e=>{e!=ne&&(se[e].socket.close(),delete se[e],delete de[e])},pe=async(e,t)=>(se[t=t||ne]||await fe(t),se[t].send(e));setInterval(()=>{const e=Date.now(),t=[];for(let s in se){if(s==ne)continue;e-se[s].lastActivity>6e4&&t.push(s)}t.forEach(e=>{le(e)})},1e4);const ge=tgMain.isTestMode;let _e=!1,he="";const ue=async(e,t,s)=>await pe(M(e,t),s);return e.addChannelUpdateState=(e,t)=>{e&&(null===t?delete x[e.id]:x[e.id]={pts:t,ah:e.access_hash},$())},e.exportAuth=async()=>{const e=[1,2,3];ge||e.push(4,5),e.forEach(async e=>{if(e==ne)return;const t=await ue("auth.exportAuthorization",{dc_id:e});await ue("auth.importAuthorization",{id:t.id,bytes:t.bytes},e)})},e.getCountry=async()=>{if(he)return he;const e=await ue("help.getNearestDc");return he=e.country,he},e.init=async()=>{if(_e)return;let e=parseInt(tgMain.getStorage("nd"))||1;if(await fe(e,!0),tgMain.getStorage("nd"))return await ue("help.getNearestDc"),void(_e=!0);const t=await ue("help.getNearestDc"),s=t.nearest_dc;he=t.country,tgProto.onCountryDetected&&tgProto.onCountryDetected(he),tgMain.setStorage("nd",s),s!=t.this_dc?(await fe(s,!0),le(e),_e=!0):_e=!0},e.initAllDc=()=>{const e=[1,2,3];ge||e.push(4,5),e.forEach(e=>{tgMain.getStorage(`ak${e}${ge?"t":""}`)||fe(e).then(()=>{le(e)})})},e.initUpdates=L,e.logOut=async()=>{tgApp.appComponent.hide(),tgMain.setStorage("user_id",null),tgMain.setStorage("us",null),tgMain.setStorage("uc",null),K={main:!1},T=null,x=null,indexedDB.deleteDatabase("tg"),clearInterval(tgApp.updatePeersStatusInterval);const e=[1,2,3];ge||e.push(4,5);const t=[];for(let s=0,n=e.length;s<n;s++)t.push(ue("auth.logOut",{},e[s]));await Promise.all(t),tgApp.appComponent.initAuth()},e.onConnect=null,e.onCountryDetected=null,e.onDisconnect=null,e.onUpdate=G,e.sendMessage=(e,t,s)=>{O=e,R=t,s?tgProto.sendMethod("messages.sendMedia",{message:t,random_id:B(),peer:e,media:s}):tgProto.sendMethod("messages.sendMessage",{message:t,random_id:B(),peer:e})},e.sendMethod=ue,e.setApiScheme=e=>{c=i(e)},e.setMainPts=e=>{T.pts=e,$()},e.setMessagesHandling=e=>{ee=e},e}({});
